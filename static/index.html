<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Po≈Ço≈ºne ‚Äì Midwife Dashboard</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        .screen {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }
        .screen.active {
            display: flex;
            flex-direction: column;
        }
        .container {
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1, h2 { color: #333; margin: 0 0 20px 0; }
        h1 { font-size: 28px; }
        h2 { font-size: 20px; }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        .header-title { display: flex; align-items: center; gap: 15px; }
        .emoji { font-size: 36px; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }
        button:hover { background: #0056b3; }
        button.secondary { background: #6c757d; }
        button.secondary:hover { background: #545b62; }
        button.logout { background: #dc3545; width: auto; }
        button.logout:hover { background: #c82333; }
        .alert {
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .alert.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .alert.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .tab-button {
            background: none;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 500;
            color: #666;
        }
        .tab-button:hover { color: #007bff; }
        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
        }
        .card h3 { margin: 0 0 10px 0; font-size: 16px; }
        .card-meta {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
        }
        .card-actions button {
            flex: 1;
            padding: 8px 12px;
            font-size: 13px;
        }
        .event-item {
            background: #f9f9f9;
            padding: 12px;
            border-left: 3px solid #007bff;
            margin-bottom: 10px;
            font-size: 13px;
            border-radius: 2px;
        }
        .event-type { font-weight: 600; color: #333; }
        .event-time { float: right; color: #999; font-size: 12px; }
        .event-meta { color: #666; font-size: 12px; margin-top: 5px; }
        .small { font-size: 12px; color: #666; }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 500; margin-bottom: 5px; color: #333; }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-active { background: #d4edda; color: #155724; }
        .status-closed { background: #e2e3e5; color: #383d41; }
    </style>
</head>
<body>
    <!-- SCREEN 1: Login -->
    <div id="screen-login" class="screen active">
        <div class="container">
            <div class="emoji">ü§∞</div>
            <h1>Po≈Ço≈ºne</h1>
            <p>Secure midwife + pregnant woman collaboration</p>
            
            <div style="margin: 40px 0;">
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Are you a:</p>
                <button onclick="goToMidwifeEntry()">ü©∫ Midwife</button>
                <button class="secondary" onclick="goToWomanEntry()">üë©‚Äçü¶∞ Pregnant Person</button>
            </div>
        </div>
    </div>

    <!-- SCREEN 2: Midwife Login -->
    <div id="screen-midwife-login" class="screen">
        <div class="container">
            <button class="secondary" onclick="goToWelcome()" style="margin-bottom: 20px;">‚Üê Back</button>
            <h2>Midwife Login</h2>
            <div class="form-group">
                <label>Username:</label>
                <input type="text" id="mw-username" value="midwife1" />
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="mw-password" value="pw" />
            </div>
            <button onclick="midwifeLogin()">Login</button>
            <div id="mw-error"></div>
        </div>
    </div>

    <!-- SCREEN 3: Woman Entry (PIN + QR) -->
    <div id="screen-woman-entry" class="screen onboarding">
        <div class="container">
            <button class="secondary" onclick="goToWelcome()" style="margin-bottom: 20px;">‚Üê Back</button>
            <div class="emoji">üë©‚Äçü¶∞</div>
            <h2>Welcome!</h2>
            <p>Create a PIN to secure your profile</p>
            
            <div class="form-group">
                <label>Choose a 4-digit PIN:</label>
                <div class="pin-input">
                    <input type="password" id="pin1" maxlength="1" inputmode="numeric" />
                    <input type="password" id="pin2" maxlength="1" inputmode="numeric" />
                    <input type="password" id="pin3" maxlength="1" inputmode="numeric" />
                    <input type="password" id="pin4" maxlength="1" inputmode="numeric" />
                </div>
            </div>
            <button onclick="setPIN()">Set PIN & Continue</button>
            <div id="woman-error"></div>
        </div>
    </div>

    <!-- SCREEN 4: Woman - Scan App Link (Midwife shares) -->
    <div id="screen-woman-scan-app" class="screen onboarding">
        <div class="container">
            <button class="secondary" onclick="resetWomanFlow()" style="margin-bottom: 20px;">‚Üê Back</button>
            <div class="emoji">üì±</div>
            <h2>Scan Midwife's Link</h2>
            <p>Ask your midwife to share a QR code. Scan it to connect.</p>
            
            <div style="margin: 30px 0; padding: 20px; background: #f0f0f0; border-radius: 8px; border: 2px dashed #999;">
                <p style="color: #666; font-size: 13px; margin: 0;">üì∑ Camera/QR Scanner</p>
                <p style="color: #999; font-size: 12px; margin: 10px 0 0 0;">(In real app, opens camera)</p>
            </div>
            
            <p style="text-align: center; color: #666; font-size: 13px;">OR</p>
            <button onclick="skipScanAppLink()">I Have a Join Code Instead</button>
        </div>
    </div>

    <!-- SCREEN 5: Woman - Share Join Code QR -->
    <div id="screen-woman-share-qr" class="screen onboarding">
        <div class="container">
            <button class="secondary" onclick="goToWomanScanApp()" style="margin-bottom: 20px;">‚Üê Back</button>
            <div class="emoji">‚ú®</div>
            <h2>Connected to a Case!</h2>
            <p>Share this QR code with your midwife to complete setup.</p>
            
            <div id="qr-container"></div>
            
            <div class="code-display" id="code-display"></div>
            
            <p style="color: #666; font-size: 13px; text-align: center;">
                Midwife scans this code to confirm they're connected to your case.
            </p>
            
            <button onclick="goToWomanApp()">Done! Go to App</button>
        </div>
    </div>

    <!-- SCREEN 6: Woman - App (Events, etc.) -->
    <div id="screen-woman-app" class="screen">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Case <span id="woman-case-id"></span></h2>
                <button class="logout-btn" onclick="logout()" style="width: auto; margin: 0;">Logout</button>
            </div>
            
            <div class="tabs">
                <button class="tab-button active" onclick="switchWomanTab('sync')">Log Events</button>
                <button class="tab-button" onclick="switchWomanTab('feed')">View Feed</button>
            </div>
            
            <div id="woman-sync" class="tab-content active">
                <div class="form-group">
                    <label>Event Type:</label>
                    <select id="event-type" onchange="updateEventPayload()">
                        <option value="">Select...</option>
                        <option value="labor_event">Labor Event</option>
                        <option value="contraction_start">Contraction Start</option>
                        <option value="contraction_end">Contraction End</option>
                        <option value="postpartum_checkin">Postpartum Check-in</option>
                    </select>
                </div>
                <div id="event-payload"></div>
                <button onclick="syncEvents()">Sync Events</button>
                <div id="sync-result" style="margin-top: 15px;"></div>
            </div>
            
            <div id="woman-feed" class="tab-content">
                <button onclick="loadCaseEvents()" style="margin-bottom: 15px;">Refresh Feed</button>
                <div id="events-list"></div>
            </div>
        </div>
    </div>

    <!-- SCREEN 7: Midwife - Main App -->
    <div id="screen-midwife-app" class="screen">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">Midwife Dashboard</h2>
                <button class="logout-btn" onclick="logout()" style="width: auto; margin: 0;">Logout</button>
            </div>
            
            <div class="tabs">
                <button class="tab-button active" onclick="switchMidwifeTab('cases')">Cases</button>
                <button class="tab-button" onclick="switchMidwifeTab('qr')">Share QR</button>
                <button class="tab-button" onclick="switchMidwifeTab('scan')">Scan Woman's QR</button>
            </div>
            
            <div id="midwife-cases" class="tab-content active">
                <button onclick="createCase()" style="margin-bottom: 15px;">+ Create Case</button>
                <div id="cases-list"></div>
            </div>
            
            <div id="midwife-qr" class="tab-content">
                <p>Share this QR code with the pregnant person so they can access the app:</p>
                <div class="qr-code-display" id="app-qr-container"></div>
            </div>
            
            <div id="midwife-scan" class="tab-content">
                <p>Scan the pregnant person's QR code to confirm you're connected:</p>
                <div style="margin: 20px 0; padding: 20px; background: #f0f0f0; border-radius: 8px; border: 2px dashed #999;">
                    <p style="color: #666; font-size: 13px; margin: 0;">üì∑ Camera/QR Scanner</p>
                    <p style="color: #999; font-size: 12px; margin: 10px 0 0 0;">(In real app, opens camera)</p>
                </div>
                <p style="text-align: center; color: #666; font-size: 13px;">OR</p>
                <div class="form-group">
                    <label>Enter join code manually:</label>
                    <input type="text" id="manual-join-code" placeholder="ABCD12" />
                </div>
                <button onclick="confirmJoinCode()">Confirm Connection</button>
                <div id="scan-result"></div>
            </div>
        </div>
    </div>

    <script>
        const API = "http://localhost:8000/api/v1";
        let token = null;

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(`${API}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                if (!res.ok) throw new Error('Login failed');
                
                const data = await res.json();
                token = data.token;
                showScreen('screen-dashboard');
                listCases();
            } catch (err) {
                document.getElementById('login-error').innerHTML = `<div class="alert error">${err.message}</div>`;
            }
        }

        function logout() {
            token = null;
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('login-error').innerHTML = '';
            showScreen('screen-login');
        }

        async function createCase() {
            try {
                const res = await fetch(`${API}/cases`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Create failed');
                
                const data = await res.json();
                alert(`Case created!\n\nJoin code: ${data.join_code}\n\nShare with the pregnant person in person.`);
                listCases();
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        async function listCases() {
            try {
                const res = await fetch(`${API}/cases?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('List failed');
                
                const data = await res.json();
                let html = '';
                
                if (data.cases.length === 0) {
                    html = '<p style="color: #666;">No cases yet. Create one to get started.</p>';
                } else {
                    html = '<div class="grid">';
                    for (const c of data.cases) {
                        const statusClass = c.status === 'active' ? 'status-active' : 'status-closed';
                        html += `
                            <div class="card">
                                <h3>${c.case_id.substring(0, 8)}</h3>
                                <div class="card-meta">
                                    <p style="margin: 5px 0;"><strong>Status:</strong> <span class="status-badge ${statusClass}">${c.status}</span></p>
                                    <p style="margin: 5px 0;"><strong>Labor:</strong> ${c.labor_active ? 'üü¢ Active' : '‚ö™ Inactive'}</p>
                                    <p style="margin: 5px 0;"><strong>Postpartum:</strong> ${c.postpartum_active ? 'üü¢ Active' : '‚ö™ Inactive'}</p>
                                    <p style="margin: 5px 0; font-size: 11px;"><strong>Created:</strong> ${new Date(c.created_at).toLocaleString()}</p>
                                </div>
                                <div class="card-actions">
                                    <button onclick="viewCaseEvents('${c.case_id}')">View Events</button>
                                    ${c.status === 'active' ? `<button class="secondary" onclick="closeCase('${c.case_id}')">Close</button>` : ''}
                                </div>
                            </div>
                        `;
                    }
                    html += '</div>';
                }
                
                document.getElementById('cases-list').innerHTML = html;
                
                // Populate history dropdown
                let options = '<option value="">Choose a case...</option>';
                for (const c of data.cases) {
                    options += `<option value="${c.case_id}">${c.case_id.substring(0, 8)}</option>`;
                }
                document.getElementById('history-case-select').innerHTML = options;
            } catch (err) {
                document.getElementById('cases-list').innerHTML = `<div class="alert error">${err.message}</div>`;
            }
        }

        async function closeCase(id) {
            if (!confirm('Close this case?')) return;
            
            try {
                const res = await fetch(`${API}/cases/${id}/close`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Close failed');
                listCases();
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        async function viewCaseEvents(caseId) {
            try {
                const res = await fetch(`${API}/cases/${caseId}/events?limit=100`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Load failed');
                
                const data = await res.json();
                let html = '';
                
                if (data.events.length === 0) {
                    html = '<p style="color: #666;">No events yet.</p>';
                } else {
                    for (const ev of data.events) {
                        html += `
                            <div class="event-item">
                                <div>
                                    <span class="event-type">${ev.type}</span>
                                    <span class="event-time">${new Date(ev.ts).toLocaleString()}</span>
                                </div>
                                <div class="event-meta">
                                    Track: <strong>${ev.track}</strong> | Source: <strong>${ev.source}</strong>
                                </div>
                                ${ev.payload ? `<pre style="margin: 8px 0 0 0; font-size: 11px; background: #f0f0f0; padding: 8px; border-radius: 2px;">${JSON.stringify(ev.payload, null, 2)}</pre>` : ''}
                            </div>
                        `;
                    }
                }
                
                alert(`Events for ${caseId.substring(0, 8)}:\n\n${data.events.length} total events\n\nView in console for details.`);
                console.log(data.events);
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        async function loadAlerts() {
            try {
                const res = await fetch(`${API}/alerts?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Load failed');
                
                const data = await res.json();
                let html = '';
                
                if (data.alerts.length === 0) {
                    html = '<p style="color: #666;">No alerts.</p>';
                } else {
                    for (const alert of data.alerts) {
                        html += `
                            <div class="event-item">
                                <div>
                                    <span class="event-type">${alert.payload.alert_code || 'alert'}</span>
                                    <span class="event-time">${new Date(alert.ts).toLocaleString()}</span>
                                </div>
                                <div class="event-meta">Case: ${alert.case_id.substring(0, 8)}</div>
                            </div>
                        `;
                    }
                }
                
                document.getElementById('alerts-list').innerHTML = html;
            } catch (err) {
                document.getElementById('alerts-list').innerHTML = `<div class="alert error">${err.message}</div>`;
            }
        }

        async function loadCaseHistory() {
            const caseId = document.getElementById('history-case-select').value;
            if (!caseId) {
                document.getElementById('history-events').innerHTML = '';
                return;
            }
            
            try {
                const res = await fetch(`${API}/cases/${caseId}/events?limit=100`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error('Load failed');
                
                const data = await res.json();
                let html = '';
                
                if (data.events.length === 0) {
                    html = '<p style="color: #666;">No events for this case.</p>';
                } else {
                    for (const ev of data.events) {
                        html += `
                            <div class="event-item">
                                <div>
                                    <span class="event-type">${ev.type}</span>
                                    <span class="event-time">${new Date(ev.ts).toLocaleString()}</span>
                                </div>
                                <div class="event-meta">
                                    Track: <strong>${ev.track}</strong> | Source: <strong>${ev.source}</strong>
                                </div>
                                ${ev.payload ? `<pre style="margin: 8px 0 0 0; font-size: 11px; background: #f0f0f0; padding: 8px; border-radius: 2px;">${JSON.stringify(ev.payload, null, 2)}</pre>` : ''}
                            </div>
                        `;
                    }
                }
                
                document.getElementById('history-events').innerHTML = html;
            } catch (err) {
                document.getElementById('history-events').innerHTML = `<div class="alert error">${err.message}</div>`;
            }
        }

        // Load alerts when alerts tab is clicked
        document.addEventListener('DOMContentLoaded', () => {
            // Override tab switch to load alerts on demand
            window.switchTabOverride = switchTab;
            window.switchTab = function(tabName) {
                switchTabOverride(tabName);
                if (tabName === 'alerts') {
                    loadAlerts();
                }
            };
        });
    </script>
</body>
</html>
